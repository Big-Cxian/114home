<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link rel="stylesheet" href="../css/mui.min.css" />
  <link rel="stylesheet" href="../css/mui.picker.min.css" />
  <link rel="stylesheet" href="../css/mui.poppicker.css" />
	<link rel="stylesheet" href="../css/app.css" />
  <style type="text/css">
    .image-list {
      margin-top: 0;
      margin-bottom: 5px;
    }
    .mui-card>p {
      padding: 11px 15px 0;
    }
  </style>
</head>

<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"><span class="font14">返回</span></a>
		<h1 class="mui-title" id="title">企业商铺认证</h1>
	</header>
	<div id="myapp" class="mui-content" v-cloak>
		<div class="mui-card">
			<form class="mui-input-group no-border-before no-border-after">
				<div class="mui-input-row">
					<label>营业执照名称</label>
					<input type="text" v-model="authenticationData.license_name" placeholder="无名称请填写经营者姓名" >
				</div>
				<div class="mui-input-row height-auto">
					<label>统一社会信用代码</label>
					<input type="text" v-model="authenticationData.credit_code" placeholder="营业执照注册号" >
				</div>
				<div class="mui-input-row height-auto">
					<label>营业执照所在地</label>
					<input type="text" v-model="authenticationData.license_address" placeholder="四川--成都" >
				</div>
	      <div class="mui-input-row">
	      	<label>执照有效日期</label>
	      	<div class="mui-switch mui-switch-blue" id="switch" :class="authenticationData.license_type == '1'?'':'mui-active'">
	      		<span class="mui-text-right">固定</span>
	      		<span class="mui-text-left">永久</span>
	      		<div class="mui-switch-handle"></div>
	      	</div>
	      </div>
	      <div class="mui-input-row height-auto">
	      	<label>有效日期至</label>
	        <input id="beginTime" class="mui-text-left" type="button" v-model="authenticationData.license_date">
	      </div>
	      <div class="mui-input-row height-auto">
	      	<label>法人姓名</label>
	      	<input type="text" v-model="authenticationData.name" placeholder="请输入姓名" >
	      </div>
	      <div class="mui-input-row height-auto">
	      	<label>法人身份证号</label>
	      	<input type="text" v-model="authenticationData.identity_id" placeholder="请输入身份证号" >
	      </div>
			</form>
		</div>
		<div class="mui-card">
	    <p class="margin0 font12">*请上传营业执照相片（请确保证件完整，清晰可见）</p>
			<ul class="image-list mui-clearfix">
				<li v-for="(item,index) in bannerData" :id="item.id">
					<img :src="item.url" />
					<span><i class="mui-icon mui-icon-closeempty" @click="delBanner(index)" :data-index="index"></i></span>
				</li>
				<li id="addImage2">
					<i class="mui-icon mui-icon-plusempty"></i>
					<br />
					<small>上传图片</small>
				</li>
			</ul>
		</div>
	  <div class="mui-card">
	    <p class="margin0 font12">*请上传正反身份证</p>
	  	<ul class="image-list mui-clearfix">
	  		<li v-for="(item,index) in imageData" :id="item.id">
	  			<img :src="item.url" />
	  			<span><i class="mui-icon mui-icon-closeempty" @click="delImage(index)" :data-index="index"></i></span>
	  		</li>
	  		<li id="addImage" v-show="imageData.length < 2">
	  			<i class="mui-icon mui-icon-plusempty"></i>
	  			<br />
	  			<small>上传图片</small>
	  		</li>
	  	</ul>
	  </div>
		<div class="mui-content-padded margin-top-20">
			<button type="button" class="mui-btn mui-btn-royal mui-btn-block buttom-button" id="save">
				<i class="mui-icon mui-icon-checkmarkempty"></i>
					提交审核
			</button>
		</div>
	</div>
<script type="text/javascript" src="../js/mui.min.js"></script>
<script type="text/javascript" src="../js/vue.min.js" ></script>
<script type="text/javascript" src="../js/jquery-3.3.1.min.js" ></script>
<script type="text/javascript" src="../js/mui.picker.min.js" ></script>
<script type="text/javascript" src="../js/mui.poppicker.js" ></script>
<script type="text/javascript" src="../js/app.js" ></script>
<script type="text/javascript" src="../js/uploader.js"></script>
<script type="text/javascript">
	mui.init();document.addEventListener('get_img', function(event) {
	  // console.log(JSON.stringify(event.detail));
		vm.imageData = event.detail.imageData;
		vm.bannerData = event.detail.bannerData;
	});
	pageId = "enterprise-store";
  vm = new Vue({
    el: '#myapp',
    data: {
      storeData: "",
      authenticationData: "",
      imageData: [],
      bannerData: []
    },
    methods: {
      delImage: function(_index) {
//				console.log(JSON.stringify(vm.imageData[_index]))
        vm.imageData.splice(_index,1);
      },
      delBanner: function(_index) {
        vm.bannerData.splice(_index,1);
      }
    }
  })
	mui.plusReady(function (){
    var heard = plus.webview.currentWebview();
    // console.log(JSON.stringify(heard));
    vm.storeData = heard.data;
    vm.imageData = vm.authenticationData.imgList1 || [];
    vm.bannerData = vm.authenticationData.imgList2 || [];
    vm.authenticationData = heard.authenticationData;
    if(!vm.authenticationData.license_type) {
      vm.authenticationData.license_type = "2";
      vm.authenticationData.license_date = "永久期限";
      $("#beginTime").prop("disabled","disabled");
    }
    $("#addImage,#addImage2").on("tap",function(){
    	if(this.id == "addImage2") {
    		imageType = "banner";
    	} else {
    		imageType = "idcard";
    	}
    	showActionSheet();
    })
    $("#switch").on('tap', function(event) {
      // console.log(vm.authenticationData.license_type);
      if(vm.authenticationData.license_type == "1") {
        vm.authenticationData.license_type = "2";
        vm.authenticationData.license_date = "永久期限";
        $("#beginTime").prop("disabled","disabled");
      } else {
        vm.authenticationData.license_type = "1";
        vm.authenticationData.license_date = "";
        $("#beginTime").prop("disabled","");
      }
    });
    var options = JSON.parse('{"type":"date"}');
    var beginTime = new mui.DtPicker(options);
    $("#beginTime").on("tap",function() {
    	beginTime.show(function(rs) {
    		vm.authenticationData.license_date = rs.text;
    	});
    })
    $("#save").on("tap",function(){
      var top_imgs = [];
      for(var i=0;i<vm.imageData.length;i++) {
        if(vm.imageData[i].id) {
          top_imgs.push(vm.imageData[i].id);
        }
      }
      var banner_imgs = [];
      for(var i=0;i<vm.bannerData.length;i++) {
        if(vm.bannerData[i].id) {
          banner_imgs.push(vm.bannerData[i].id);
        }
      }
      doAjax("/company/store/editStore",{
        _token: UserInfo.data._token,
        type: 3,
        param: JSON.stringify({
          type: "3", //2 企业商家认证
          name: vm.authenticationData.name, //法人姓名
          identity_id: vm.authenticationData.identity_id,//法人身份证号
          license_name: vm.authenticationData.license_name, //营业执照名称
          credit_code: vm.authenticationData.credit_code, //统一社会信用代码
          license_address: vm.authenticationData.license_address, //营业执照所在地
          license_type: vm.authenticationData.license_type, //选中为1固定期限 不选2永久期限
          license_date: vm.authenticationData.license_type == "1" ? vm.authenticationData.license_date : "", //执照到期时间 license_type =1 才需要填
          imgs1: top_imgs.join(), //身份证正反面
          imgs2: banner_imgs.join() //营业执照信息
        })
      },function(_data,_msg) {
        console.log(JSON.stringify(_data));
        vm.storeData.certification_type = 1;
        vm.storeData.certification_status = 0;
        vm.storeData.certification_status_text = "审核中";
        mui.fire(plus.webview.getWebviewById("store"), 'get_detail', {
          storeData: vm.storeData
        });
        mui.toast(_msg);
        mui.back();
      })
    })
  })
</script>
</body>

</html>